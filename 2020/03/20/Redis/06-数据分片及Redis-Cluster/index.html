<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Redis/06-数据分片及Redis-Cluster | Hexo</title>
  <meta name="keywords" content="">
  <meta name="description" content="Redis/06-数据分片及Redis-Cluster | Hexo">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="http://yoursite.com/about/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-03-19T16:29:46.000Z">
<meta property="article:modified_time" content="2020-03-19T16:29:46.804Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="icon" href="/img/icon.jpg">

<link href="/css/style.css?v=1.0.1" rel="stylesheet">

<link href="/css/hl_theme/atom-light.css?v=1.0.1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1.0.1" ></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js" ></script>

<script src="/js/iconfont.js?v=1.0.1" ></script>

<meta name="generator" content="Hexo 4.2.0"></head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value="">
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/icon.jpg" />
</a>
<div class="author">
    <span>John Doe</span>
</div>

<div class="icon">
    
        
        <a title="email" href="mailto:1135038815@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=1135038815&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(13)</small></div></li>
    
        
            
            <li><div data-rel="工具">工具<small>(1)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    </div>
    <div><a class="about  site_url"  href="/about">关于</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="13">
<input type="hidden" id="yelog_site_word_count" value="21.8k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode === 13){return false;}">
        <input id="local-search-input" class="search" type="text" placeholder="以 in: 开头进行全文搜索" />
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a class="color2">a</a>
    </li>
    
    <li class="article-tag-list-item">
        <a class="color2">b</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <div id="local-search-result">

    </div>
    
    <nav id="title-list-nav">
        
        <a  class="工具 "
           href="/2020/03/19/test/"
           data-tag="a,b"
           data-author="" >
            <span class="post-title" title="test">test</span>
            <span class="post-date" title="2020-03-19 23:39:26">2020/03/19</span>
        </a>
        
        <a  class=""
           href="/2020/03/19/hello-world/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Hello World">Hello World</span>
            <span class="post-date" title="2020-03-19 21:24:22">2020/03/19</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/04-Redis%E6%8C%81%E4%B9%85%E5%8C%96/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/04-Redis持久化">Redis/04-Redis持久化</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/01-Redis%E4%BB%8B%E7%BB%8D%E5%8F%8ANIO%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/01-Redis介绍及NIO原理介绍">Redis/01-Redis介绍及NIO原理介绍</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/03-Redis%E4%BD%BF%E7%94%A8%E8%BF%9B%E9%98%B6/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/03-Redis使用进阶">Redis/03-Redis使用进阶</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/08-%E5%88%9D%E8%AF%86zk/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/08-初识zk">Redis/08-初识zk</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/02-Redis%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/02-Redis数据类型和使用场景">Redis/02-Redis数据类型和使用场景</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/05-Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8F%8A%E9%AB%98%E5%8F%AF%E7%94%A8/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/05-Redis主从复制及高可用">Redis/05-Redis主从复制及高可用</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/09-zk%E8%BF%9B%E9%98%B6/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/09-zk进阶">Redis/09-zk进阶</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/06-%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%E5%8F%8ARedis-Cluster/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/06-数据分片及Redis-Cluster">Redis/06-数据分片及Redis-Cluster</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/README/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/README">Redis/README</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/07-Redis%E5%AE%9E%E6%88%98/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/07-Redis实战">Redis/07-Redis实战</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
        <a  class=""
           href="/2020/03/20/Redis/SUMMARY/"
           data-tag=""
           data-author="" >
            <span class="post-title" title="Redis/SUMMARY">Redis/SUMMARY</span>
            <span class="post-date" title="2020-03-20 23:32:59">2020/03/20</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-Redis/06-数据分片及Redis-Cluster" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">Redis/06-数据分片及Redis-Cluster</h1>
    
    <div class="article-meta">
        
        
        
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2020-03-03 23:16:45'>2020-03-20 23:32</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:3.9k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#数据分片及Redis-Cluster"><span class="toc-text">数据分片及Redis-Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#技术推演"><span class="toc-text">技术推演</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实操"><span class="toc-text">实操</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#twemproxy代理"><span class="toc-text">twemproxy代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实验步骤"><span class="toc-text">实验步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#predixy代理"><span class="toc-text">predixy代理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实验步骤-1"><span class="toc-text">实验步骤</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-Cluster"><span class="toc-text">Redis Cluster</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#实验步骤-2"><span class="toc-text">实验步骤</span></a></li></ol></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-3 i,
    .toc-level-3 ol {
        display: none !important;
    }
</style>
</div>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="数据分片及Redis-Cluster"><a href="#数据分片及Redis-Cluster" class="headerlink" title="数据分片及Redis-Cluster"></a>数据分片及Redis-Cluster</h1><h2 id="技术推演"><a href="#技术推演" class="headerlink" title="技术推演"></a>技术推演</h2><p>​    一图胜千言，图片涵盖了整个推演过程，包括：</p>
<ol>
<li>为什么要进行 y 轴扩展及扩展方式：按业务、功能分库</li>
<li>y轴扩展仍存在压力问题的可能，因此需要z轴扩展，扩展思路是数据分片</li>
<li>数据分片方案一：客户端分区，存在问题：redis端连接成本高</li>
<li>为了解决方案一的问题，产生方案二：代理分区</li>
<li>方案一和二存在共同问题：不适合做数据库，否则增删节点很麻烦</li>
<li>问题的解决方案：预分区</li>
<li>数据分片方案三：查询路由，落地方案是Redis Cluster，实现了预分区，可做数据库</li>
</ol>
<p><img src="./pics/redis%E4%BB%A3%E7%90%86%E5%8F%8A%E9%9B%86%E7%BE%A4.jpg" alt="redis代理及集群"></p>
<h2 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h2><h3 id="twemproxy代理"><a href="#twemproxy代理" class="headerlink" title="twemproxy代理"></a>twemproxy代理</h3><p>​    twemproxy是一款被广泛使用的轻量级 Redis 和 Memcached 代理技术，相当于下图粉色部分。<a href="https://github.com/twitter/twemproxy/" target="_blank" rel="noopener">github主页</a></p>
<p><img src="./pics/redis-proxy.png" alt="redis-proxy"></p>
<h4 id="实验步骤"><a href="#实验步骤" class="headerlink" title="实验步骤"></a>实验步骤</h4><ol>
<li>下载、编译、配置、运行</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装编译需要的工具包</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> yum install -y automake libtool</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wget https://github.com/twitter/twemproxy/archive/master.zip</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> unzip master.zip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> twemproxy-master</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> autoreconf -fvi</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./configure --<span class="built_in">enable</span>-debug=full</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> make</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 看到正常的帮助信息，说明编译完成</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> src/nutcracker -h</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp src/nutcracker /usr/bin</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建 twemproxy 服务，根据 nutcracker.init 中的内容，将配置文件复制到指定目录下</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp scripts/nutcracker.init /etc/init.d/twemproxy</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> chmod +x /etc/init.d/twemproxy</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p /etc/nutcracker/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp conf/nutcracker.* /etc/nutcracker/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /etc/nutcracker/</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 备份一下配置文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp nutcracker.yml nutcracker.yml.bak</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi nutcracker.yml</span></span><br></pre></td></tr></table></figure>

<p>​    <code>nutcracker.yml</code>中进行如下配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> alpha 一个名称，可随意起</span></span><br><span class="line">alpha:</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 代理对外提供的服务地址</span></span><br><span class="line">  listen: 127.0.0.1:22121</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 哈希函数</span></span><br><span class="line">  hash: fnv1a_64</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 数据分片方式，支持ketama、modula、random</span></span><br><span class="line">  distribution: ketama</span><br><span class="line">  auto_eject_hosts: true</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 后端是否是 redis。默认为 <span class="literal">false</span>，代理 memcached</span></span><br><span class="line">  redis: true</span><br><span class="line">  server_retry_timeout: 2000</span><br><span class="line">  server_failure_limit: 1</span><br><span class="line"><span class="meta">  #</span><span class="bash"> 后端服务的地址：权重</span></span><br><span class="line">  servers:</span><br><span class="line">   - 127.0.0.1:6379:1</span><br><span class="line">   - 127.0.0.1:6380:1</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> TODO：自行在本机上运行两个 redis-server，端口分别是 6379 和 6380</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> service twemproxy start</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>测试效果</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 连接 tewmproxy 代理服务</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-cli -p 22121</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> k1 a</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> get k1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> k2 b</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> k3 c</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> 1 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> get 1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>set</code>、<code>get</code>命令都能成功成功执行，说明代理正常提供服务</p>
<p>连接两个后端 redis，通过 <code>keys *</code>命令可以发现 k1、k2、k3落在一个节点上，1落在另一个节点上</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> twemproxy的局限性，聚合/事务 命令不再支持</span></span><br><span class="line">127.0.0.1:22121&gt; keys *</span><br><span class="line">Error: Server closed the connection</span><br><span class="line">127.0.0.1:22121&gt; WATCH k1</span><br><span class="line">Error: Server closed the connection</span><br><span class="line">127.0.0.1:22121&gt; MULTI</span><br><span class="line">Error: Server closed the connection</span><br></pre></td></tr></table></figure>



<h3 id="predixy代理"><a href="#predixy代理" class="headerlink" title="predixy代理"></a>predixy代理</h3><p>​    predixy是一款高性能全特征 redis 代理，支持 redis-sentinel 和 redis-cluster。比较小众，但是功能较强。<a href="https://github.com/joyieldInc/predixy/blob/master/README_CN.md" target="_blank" rel="noopener">github README</a></p>
<h4 id="实验步骤-1"><a href="#实验步骤-1" class="headerlink" title="实验步骤"></a>实验步骤</h4><ol>
<li>下载、配置</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget https://github.com/joyieldInc/predixy/releases/download/1.0.5/predixy-1.0.5-bin-amd64-linux.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tar xf predixy-1.0.5-bin-amd64-linux.tar.gz</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> predixy-1.0.5/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> conf/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi predixy.conf</span></span><br></pre></td></tr></table></figure>

<p>​    <code>predixy.conf</code>中修改两处：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################## GENERAL ####################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Predixy configuration file example</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Specify a name for this predixy service</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># redis command INFO can get this</span></span></span><br><span class="line">Name PredixyExample</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Specify listen address, support IPV4, IPV6, Unix socket</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Examples:</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启proxy监听端口</span></span><br><span class="line">Bind 127.0.0.1:7617</span><br><span class="line"><span class="meta">#</span><span class="bash"> Bind 0.0.0.0:7617</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Bind /tmp/predixy</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Default is 0.0.0.0:7617</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Bind 0.0.0.0:7617</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">################################## SERVERS ####################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Include cluster.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动哨兵配置。目前 predixy 不支持同时开启 sentinel 和 redis-cluster</span></span><br><span class="line">Include sentinel.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"> Include try.conf</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vi sentinel.conf</span></span><br><span class="line">SentinelServerPool &#123;</span><br><span class="line">    Databases 16</span><br><span class="line">    Hash crc16</span><br><span class="line">    # 设置 hashtag 标记为“&#123;&#125;”，以后带有相同tag（如&#123;xx&#125;k1、&#123;xx&#125;k2）的key会落在同一个Redis节点上</span><br><span class="line">    HashTag "&#123;&#125;"</span><br><span class="line">    Distribution modula</span><br><span class="line">    MasterReadPriority 60</span><br><span class="line">    StaticSlaveReadPriority 50</span><br><span class="line">    DynamicSlaveReadPriority 50</span><br><span class="line">    RefreshInterval 1</span><br><span class="line">    ServerTimeout 1</span><br><span class="line">    ServerFailureLimit 10</span><br><span class="line">    ServerRetryTimeout 1</span><br><span class="line">    KeepAlive 120</span><br><span class="line">    Sentinels &#123;</span><br><span class="line">        # 配置 3 个哨兵</span><br><span class="line">        + 127.0.0.1:26379</span><br><span class="line">        + 127.0.0.1:26380</span><br><span class="line">        + 127.0.0.1:26381</span><br><span class="line">    &#125;</span><br><span class="line">    # 哨兵监控的master的逻辑名称，配置2个Group代表一套哨兵监控两套Redis主从</span><br><span class="line">    Group ooxx &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    Group xxoo &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>运行哨兵</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建3个哨兵的配置文件，分别是26379.conf，26380.conf和26381.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 仅以 26379.conf 文件内容为例，其余两个文件内容仅端口号不同</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> vi 26379.conf</span></span><br><span class="line">port 26379</span><br><span class="line">sentinel monitor ooxx 127.0.0.1 36379 2</span><br><span class="line">sentinel monitor xxoo 127.0.0.1 46379 2</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-sentinel 26379.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-sentinel 26380.conf</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-sentinel 26381.conf</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>运行 2 套 Redis 主从</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> redis-server -p 36379</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-server  --port 36380 --replicaof 127.0.0.1 36379</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-server -p 46379</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> redis-server  --port 46380 --replicaof 127.0.0.1 46379</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>运行predixy</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /opt/predixy-1.0.5/bin</span></span><br><span class="line">[root@localhost bin]# ./predixy ../conf/predixy.conf</span><br><span class="line">2020-02-03 17:56:45.214802 N Proxy.cpp:112 predixy listen in 127.0.0.1:7617</span><br><span class="line">2020-02-03 17:56:45.214952 N Proxy.cpp:143 predixy running with Name:PredixyExample Workers:1</span><br><span class="line">2020-02-03 17:56:45.215167 N Handler.cpp:454 h 0 create connection pool for server 127.0.0.1:26381</span><br><span class="line">2020-02-03 17:56:45.215226 N ConnectConnectionPool.cpp:42 h 0 create server connection 127.0.0.1:26381 5</span><br><span class="line">2020-02-03 17:56:45.253767 N Handler.cpp:454 h 0 create connection pool for server 127.0.0.1:26380</span><br><span class="line">2020-02-03 17:56:45.253826 N ConnectConnectionPool.cpp:42 h 0 create server connection 127.0.0.1:26380 6</span><br><span class="line">2020-02-03 17:56:45.254352 N StandaloneServerPool.cpp:422 sentinel server pool group xxoo create master server 127.0.0.1:46379</span><br><span class="line">2020-02-03 17:56:45.254366 N StandaloneServerPool.cpp:472 sentinel server pool group xxoo create slave server 127.0.0.1:46380</span><br><span class="line">2020-02-03 17:56:45.254384 N StandaloneServerPool.cpp:422 sentinel server pool group ooxx create master server 127.0.0.1:36379</span><br><span class="line">2020-02-03 17:56:45.254388 N StandaloneServerPool.cpp:472 sentinel server pool group ooxx create slave server 127.0.0.1:36380</span><br><span class="line">2020-02-03 17:56:46.263990 N Handler.cpp:454 h 0 create connection pool for server 127.0.0.1:26379</span><br><span class="line">2020-02-03 17:56:46.264082 N ConnectConnectionPool.cpp:42 h 0 create server connection 127.0.0.1:26379 7</span><br></pre></td></tr></table></figure>

<p>​    从 predixy 启动日志可以看出，已经找到了两套 master-slave</p>
<p><img src="./pics/%E5%AE%9E%E9%AA%8C%E6%9E%B6%E6%9E%84.png" alt="实验架构"></p>
<ol start="5">
<li>测试效果</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 连接 predixy 代理服务</span></span><br><span class="line">[root@localhost ~]# redis-cli -p 7617</span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> 和 get 效果</span></span><br><span class="line">127.0.0.1:7617&gt; set k1 asd</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7617&gt; get k1</span><br><span class="line">"asd"</span><br><span class="line">127.0.0.1:7617&gt; set k2  ccc</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7617&gt; get k2</span><br><span class="line">"ccc"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> keys 命令也是不支持</span></span><br><span class="line">127.0.0.1:7617&gt; keys *</span><br><span class="line">(error) ERR unknown command 'keys'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置相同hashtag的keys</span></span><br><span class="line">127.0.0.1:7617&gt;  set &#123;oo&#125;k1 ccc</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7617&gt; set &#123;oo&#125;k2 zxzc</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7617&gt; get &#123;oo&#125;k1</span><br><span class="line">"ccc"</span><br><span class="line">127.0.0.1:7617&gt; get &#123;oo&#125;k2</span><br><span class="line">"zxzc"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对于当前配置（配置了多组Redis后端），不支持事务</span></span><br><span class="line">127.0.0.1:7617&gt; WATCH &#123;oo&#125;k1</span><br><span class="line">(error) ERR forbid transaction in current server pool</span><br></pre></td></tr></table></figure>

<p>​    用客户端连接后端 redis，查看数据分布</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli  -p 36379</span><br><span class="line">127.0.0.1:36379&gt; keys *</span><br><span class="line">1) "k1"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 相同hashtag的keys落在了一个Redis后端上</span></span><br><span class="line">[root@localhost ~]# redis-cli -p 46379</span><br><span class="line">127.0.0.1:46379&gt; keys *</span><br><span class="line">1) "&#123;oo&#125;k1"</span><br><span class="line">2) "k2"</span><br><span class="line">3) "&#123;oo&#125;k2"</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>关闭 predixy，修改 sentinel.conf 配置文件，去掉 <code>ooxx</code> Group后重启 predixy</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost bin]# vi ../conf/sentinel.conf</span><br><span class="line">SentinelServerPool &#123;</span><br><span class="line">    Databases 16</span><br><span class="line">    Hash crc16</span><br><span class="line">    HashTag "&#123;&#125;"</span><br><span class="line">    Distribution modula</span><br><span class="line">    MasterReadPriority 60</span><br><span class="line">    StaticSlaveReadPriority 50</span><br><span class="line">    DynamicSlaveReadPriority 50</span><br><span class="line">    RefreshInterval 1</span><br><span class="line">    ServerTimeout 1</span><br><span class="line">    ServerFailureLimit 10</span><br><span class="line">    ServerRetryTimeout 1</span><br><span class="line">    KeepAlive 120</span><br><span class="line">    Sentinels &#123;</span><br><span class="line">        + 127.0.0.1:26379</span><br><span class="line">        + 127.0.0.1:26380</span><br><span class="line">        + 127.0.0.1:26381</span><br><span class="line">    &#125;</span><br><span class="line">    # 哨兵监控的master的逻辑名称</span><br><span class="line">    Group xxoo &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@localhost bin]# ./predixy ../conf/predixy.conf</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>测试事务效果</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sentinel]# redis-cli -p 7617</span><br><span class="line"><span class="meta">#</span><span class="bash"> 即使后端只有一组 Redis，也不支持 keys 命令</span></span><br><span class="line">127.0.0.1:7617&gt; keys *</span><br><span class="line">(error) ERR unknown command 'keys'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 获取不到k1，因为原来k1被放在了 ooxx 组里</span></span><br><span class="line">127.0.0.1:7617&gt; get k1</span><br><span class="line">(nil)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其它 xxoo 组里的数据仍能获取到</span></span><br><span class="line">127.0.0.1:7617&gt; get k2</span><br><span class="line">"ccc"</span><br><span class="line">127.0.0.1:7617&gt; get &#123;oo&#125;k1</span><br><span class="line">"ccc"</span><br><span class="line">127.0.0.1:7617&gt; get &#123;oo&#125;k2</span><br><span class="line">"zxzc"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当只有一组 Redis 后端后，可以开启事务</span></span><br><span class="line">127.0.0.1:7617&gt; WATCH k1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7617&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:7617&gt; set k1 newdata</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:7617&gt; EXEC</span><br><span class="line">1) OK</span><br><span class="line">127.0.0.1:7617&gt; get k1</span><br><span class="line">"newdata"</span><br></pre></td></tr></table></figure>

<ol start="8">
<li><p>测试 sentinel 和备机</p>
<p>将 46379 服务停掉，观察现象可发现，在短暂的服务不可用（sentinel 正在将备机变成了新主节点）后，服务再次正常，数据仍在</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost sentinel]# redis-cli -p 7617</span><br><span class="line">127.0.0.1:7617&gt; get k1</span><br><span class="line">(error) ERR server connection close</span><br><span class="line">127.0.0.1:7617&gt; get k1</span><br><span class="line">"newdata"</span><br></pre></td></tr></table></figure>



<h3 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h3><p>​    Redis Cluster通过路由查询的方式实现数据分片。<a href="http://redis.cn/topics/cluster-tutorial.html" target="_blank" rel="noopener">Redis 集群初级教程</a></p>
<p><img src="./pics/Redis-Cluster.png" alt="Redis-Cluster"></p>
<h4 id="实验步骤-2"><a href="#实验步骤-2" class="headerlink" title="实验步骤"></a>实验步骤</h4><p>​    Redis 安装包里自带了一个 Redis cluster 的工具脚本，通过该脚本可以快速尝试 Redis Cluster</p>
<ol>
<li>启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost create-cluster]# cd /opt/redis-5.0.7/utils/create-cluster</span><br><span class="line">[root@localhost create-cluster]# ll</span><br><span class="line">总用量 8</span><br><span class="line">-rwxrwxr-x. 1 root root 2344 11月 20 01:05 create-cluster</span><br><span class="line">-rw-rw-r--. 1 root root 1317 11月 20 01:05 README</span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据README中的步骤进行操作</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 先配置一下脚本中的部分参数</span></span><br><span class="line">[root@localhost create-cluster]# vi create-cluster</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Settings</span></span><br><span class="line">PORT=30000</span><br><span class="line">TIMEOUT=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动6个redis节点</span></span><br><span class="line">NODES=6</span><br><span class="line"><span class="meta">#</span><span class="bash"> 副本数设置为1，即6个节点，3份Redis，每份Redis是1主1从</span></span><br><span class="line">REPLICAS=1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他配置不变</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动Redis实例</span></span><br><span class="line">[root@localhost create-cluster]# ./create-cluster start</span><br><span class="line">Starting 30001</span><br><span class="line">Starting 30002</span><br><span class="line">Starting 30003</span><br><span class="line">Starting 30004</span><br><span class="line">Starting 30005</span><br><span class="line">Starting 30006</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建集群</span></span><br><span class="line">[root@localhost create-cluster]# ./create-cluster create</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 127.0.0.1:30005 to 127.0.0.1:30001</span><br><span class="line">Adding replica 127.0.0.1:30006 to 127.0.0.1:30002</span><br><span class="line">Adding replica 127.0.0.1:30004 to 127.0.0.1:30003</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: 9eadfbf21e7b4589a7770a1ae7a64efcab8a2bca 127.0.0.1:30001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 4e8d6f113e37af7dba739c0167cf871087d1ae2e 127.0.0.1:30002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: a31cfab0ca3d376f4ffd9ff7cde65f91be20fa7e 127.0.0.1:30003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: ea8c01567da7ebcdeca71c5f61e04384dfc81a13 127.0.0.1:30004</span><br><span class="line">   replicates a31cfab0ca3d376f4ffd9ff7cde65f91be20fa7e</span><br><span class="line">S: 413b25c9a124c4be15310bd676c25a4566210828 127.0.0.1:30005</span><br><span class="line">   replicates 9eadfbf21e7b4589a7770a1ae7a64efcab8a2bca</span><br><span class="line">S: 0213aacf9991fc2d4f06a6e6ab891e24ea17778e 127.0.0.1:30006</span><br><span class="line">   replicates 4e8d6f113e37af7dba739c0167cf871087d1ae2e</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept): yes</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 127.0.0.1:30001)</span></span><br><span class="line">M: 9eadfbf21e7b4589a7770a1ae7a64efcab8a2bca 127.0.0.1:30001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 4e8d6f113e37af7dba739c0167cf871087d1ae2e 127.0.0.1:30002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 0213aacf9991fc2d4f06a6e6ab891e24ea17778e 127.0.0.1:30006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 4e8d6f113e37af7dba739c0167cf871087d1ae2e</span><br><span class="line">S: ea8c01567da7ebcdeca71c5f61e04384dfc81a13 127.0.0.1:30004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates a31cfab0ca3d376f4ffd9ff7cde65f91be20fa7e</span><br><span class="line">M: a31cfab0ca3d376f4ffd9ff7cde65f91be20fa7e 127.0.0.1:30003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 413b25c9a124c4be15310bd676c25a4566210828 127.0.0.1:30005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 9eadfbf21e7b4589a7770a1ae7a64efcab8a2bca</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<p>​    在日志中可以看到 Redis 实例主从配对情况，及16384个槽位分配情况。</p>
<ol start="2">
<li>测试效果</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 普通的 client 连接方式，命令会返回相应错误信息，告诉你应该把数据放到哪个 Redis 实例上</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli -p 30001</span><br><span class="line">127.0.0.1:30001&gt; set k1 asd</span><br><span class="line">(error) MOVED 12706 127.0.0.1:30003</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过 -c 参数指定为集群模式 client</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli -p 30001 -c</span><br><span class="line">127.0.0.1:30001&gt; set k1 asd</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [12706] located at 127.0.0.1:30003</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30003&gt; get k1</span><br><span class="line">"asd"</span><br><span class="line">127.0.0.1:30003&gt; set k2 czcx</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [449] located at 127.0.0.1:30001</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; set k3 weqw</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30003&gt; get k2</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [449] located at 127.0.0.1:30001</span></span><br><span class="line">"czcx"</span><br><span class="line">127.0.0.1:30001&gt; get k3</span><br><span class="line">"weqw"</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启事务，没有报错</span></span><br><span class="line">127.0.0.1:30003&gt; WATCH k2</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [449] located at 127.0.0.1:30001</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; set k1 czx</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [12706] located at 127.0.0.1:30003</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30003&gt; set ccc wedf</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [135] located at 127.0.0.1:30001</span></span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 提交事务时会出错，因为事务里操作了2个 Redis 实例上的数据，而MULTI 命令只提交给了30001，因此30003收到EXEC后会返回错误信息</span></span><br><span class="line">127.0.0.1:30001&gt; exec</span><br><span class="line">(error) ERR EXEC without MULTI</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置可是的hashtag，让事务操作的数据放到一个实例中，使事务正常使用</span></span><br><span class="line">127.0.0.1:30001&gt; set &#123;oo&#125;k1 aa</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; set &#123;oo&#125;k2 zxc</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; WATCH &#123;oo&#125;k1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; MULTI</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30001&gt; get &#123;oo&#125;k3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:30001&gt; set &#123;oo&#125;k2  newD</span><br><span class="line">QUEUED</span><br><span class="line"><span class="meta">#</span><span class="bash"> 成功执行事务</span></span><br><span class="line">127.0.0.1:30001&gt; EXEC</span><br><span class="line">1) (nil)</span><br><span class="line">2) OK</span><br><span class="line">127.0.0.1:30001&gt; get &#123;oo&#125;k2</span><br><span class="line">"newD"</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>关闭实例并清空，换个玩法跑集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost create-cluster]# ./create-cluster stop</span><br><span class="line">Stopping 30001</span><br><span class="line">Stopping 30002</span><br><span class="line">Stopping 30003</span><br><span class="line">Stopping 30004</span><br><span class="line">Stopping 30005</span><br><span class="line">Stopping 30006</span><br><span class="line">[root@localhost create-cluster]# ./create-cluster clean</span><br><span class="line">[root@localhost create-cluster]# ll</span><br><span class="line">总用量 8</span><br><span class="line">-rwxrwxr-x. 1 root root 2344 11月 20 01:05 create-cluster</span><br><span class="line">-rw-rw-r--. 1 root root 1317 11月 20 01:05 README</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>通过脚本帮忙启动 6 个 Redis 实例，之后集群的操作由 client 命令完成</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost create-cluster]# ./create-cluster start</span><br><span class="line">Starting 30001</span><br><span class="line">Starting 30002</span><br><span class="line">Starting 30003</span><br><span class="line">Starting 30004</span><br><span class="line">Starting 30005</span><br><span class="line">Starting 30006</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看集群相关命令的说明文档</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli --cluster help</span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过命令行创建集群，可以发现返回的日志和 ./create-cluster create 命令一样</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli --cluster create 127.0.0.1:30001 127.0.0.1:30002 127.0.0.1:30003 127.0.0.1:30004 127.0.0.1:30005 127.0.0.1:30006 --cluster-replicas 1</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 127.0.0.1:30005 to 127.0.0.1:30001</span><br><span class="line">Adding replica 127.0.0.1:30006 to 127.0.0.1:30002</span><br><span class="line">Adding replica 127.0.0.1:30004 to 127.0.0.1:30003</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e 127.0.0.1:30001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac 127.0.0.1:30002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 37e538350ef39dc7dd886325d71d4db0d6ae8c2a 127.0.0.1:30003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: f190d2e34eaf62f7aa6efcd3ee20c419651169dd 127.0.0.1:30004</span><br><span class="line">   replicates 37e538350ef39dc7dd886325d71d4db0d6ae8c2a</span><br><span class="line">S: 10d004ac7557c113b94af0eb43df2da674d5fdc0 127.0.0.1:30005</span><br><span class="line">   replicates bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line">S: ba905e12e22802e6e88884241d263eb4139fb354 127.0.0.1:30006</span><br><span class="line">   replicates d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac</span><br><span class="line">Can I set the above configuration? (type 'yes' to accept): yes</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line">.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 127.0.0.1:30001)</span></span><br><span class="line">M: bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e 127.0.0.1:30001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac 127.0.0.1:30002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 37e538350ef39dc7dd886325d71d4db0d6ae8c2a 127.0.0.1:30003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: ba905e12e22802e6e88884241d263eb4139fb354 127.0.0.1:30006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac</span><br><span class="line">S: f190d2e34eaf62f7aa6efcd3ee20c419651169dd 127.0.0.1:30004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 37e538350ef39dc7dd886325d71d4db0d6ae8c2a</span><br><span class="line">S: 10d004ac7557c113b94af0eb43df2da674d5fdc0 127.0.0.1:30005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试集群效果和集群相关 redis-cli 命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试是否正常使用</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli  -c -p 30001</span><br><span class="line">127.0.0.1:30001&gt; get k1</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [12706] located at 127.0.0.1:30003</span></span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:30003&gt; set k1 asd</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:30003&gt; set k2 czx</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [449] located at 127.0.0.1:30001</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 假设当前发生了数据倾斜，30001实例上数据太多，需要进行操作迁移</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli --cluster reshard 127.0.0.1:30001</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 127.0.0.1:30001)</span></span><br><span class="line">M: bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e 127.0.0.1:30001</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac 127.0.0.1:30002</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 37e538350ef39dc7dd886325d71d4db0d6ae8c2a 127.0.0.1:30003</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: ba905e12e22802e6e88884241d263eb4139fb354 127.0.0.1:30006</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac</span><br><span class="line">S: f190d2e34eaf62f7aa6efcd3ee20c419651169dd 127.0.0.1:30004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 37e538350ef39dc7dd886325d71d4db0d6ae8c2a</span><br><span class="line">S: 10d004ac7557c113b94af0eb43df2da674d5fdc0 127.0.0.1:30005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 移动1000个槽位到其他实例</span></span><br><span class="line">How many slots do you want to move (from 1 to 16384)? 1000</span><br><span class="line"><span class="meta">#</span><span class="bash"> 接收槽位的实例 ID</span></span><br><span class="line">What is the receiving node ID? d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac</span><br><span class="line">Please enter all the source node IDs.</span><br><span class="line">  Type 'all' to use all the nodes as source nodes for the hash slots.</span><br><span class="line">  Type 'done' once you entered all the source nodes IDs.</span><br><span class="line"><span class="meta">#</span><span class="bash"> 配置只从30001上移走槽位</span></span><br><span class="line">Source node #1: bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line">Source node #2: done</span><br><span class="line"></span><br><span class="line">Ready to move 1000 slots.</span><br><span class="line">  Source nodes:</span><br><span class="line">    M: bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e 127.0.0.1:30001</span><br><span class="line">       slots:[0-5460] (5461 slots) master</span><br><span class="line">       1 additional replica(s)</span><br><span class="line">  Destination node:</span><br><span class="line">    M: d3cfdb22d35cd6e09a07824adff3af9a18e2c0ac 127.0.0.1:30002</span><br><span class="line">       slots:[5461-10922] (5462 slots) master</span><br><span class="line">       1 additional replica(s)</span><br><span class="line">  Resharding plan:</span><br><span class="line">    Moving slot 0 from bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line">    Moving slot 1 from bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line">    Moving slot 2 from bfed58b1ec965e5b4d57edcdbd2ab92d2dc8e69e</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看30001槽位信息，可以发现30001中有1000个转到了30002</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli --cluster info 127.0.0.1:30001</span><br><span class="line">127.0.0.1:30001 (bfed58b1...) -&gt; 0 keys | 4461 slots | 1 slaves.</span><br><span class="line">127.0.0.1:30002 (d3cfdb22...) -&gt; 1 keys | 6462 slots | 1 slaves.</span><br><span class="line">127.0.0.1:30003 (37e53835...) -&gt; 1 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 2 keys in 3 masters.</span><br><span class="line">0.00 keys per slot on average.</span><br><span class="line"><span class="meta">#</span><span class="bash"> check命令可以返回更详细的信息</span></span><br><span class="line">[root@localhost create-cluster]# redis-cli --cluster check 127.0.0.1:30001</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>redis-cli  -c -p 30001</code></p>
<p><code>redis-cli --cluster reshard 127.0.0.1:30001</code></p>
<p><code>redis-cli --cluster info 127.0.0.1:30001</code></p>
<p><code>redis-cli --cluster check 127.0.0.1:30001</code></p>
</blockquote>

      
       <hr><span style="font-style: italic;color: gray;"> 转载请注明来源，欢迎对文章中的引用来源进行考证，欢迎指出任何有错误或不够清晰的表达。可以在下面评论区评论，也可以邮件至 1135038815@qq.com </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>Redis/06-数据分片及Redis-Cluster</p>
    <p><span class="copy-title">文章字数:</span><span class="post-count">3.9k</span></p>
    <p><span class="copy-title">发布时间:</span>2020-03-20, 23:32:59</p>
    <p><span class="copy-title">最后更新:</span>2020-03-03, 23:16:45</p>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license noopener" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2020-2024 Ryan</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" ></a>

    </div>
</div>
<div class="acParent"></div>

</body>
<script src="/js/jquery.pjax.js?v=1.0.1" ></script>

<script src="/js/script.js?v=1.0.1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#a','#b',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        
            $(".post .pjax table").addClass("green_title");
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: #fafafa;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    
    .nav {
        width: 542px;
    }
    .nav.fullscreen {
        margin-left: -542px;
    }
    .nav-left {
        width: 120px;
    }
    
    
    @media screen and (max-width: 1468px) {
        .nav {
            width: 492px;
        }
        .nav.fullscreen {
            margin-left: -492px;
        }
        .nav-left {
            width: 100px;
        }
    }
    
    
    @media screen and (max-width: 1024px) {
        .nav {
            width: 492px;
            margin-left: -492px
        }
        .nav.fullscreen {
            margin-left: 0;
        }
        .nav .hide-list.fullscreen {
            left: 492px
        }
    }
    
    @media screen and (max-width: 426px) {
        .nav {
            width: 100%;
        }
        .nav-left {
            width: 100%;
        }
    }
    
    
    .nav-right .title-list nav a .post-title, .nav-right .title-list #local-search-result a .post-title {
        color: #383636;
    }
    
    
    .nav-right .title-list nav a .post-date, .nav-right .title-list #local-search-result a .post-date {
        color: #5e5e5f;
    }
    
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    

    /*文章列表背景图*/
    
    .nav-right:before {
        content: ' ';
        display: block;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        opacity: 0.3;
        background: url("https://i.loli.net/2019/07/22/5d3521411f3f169375.png");
        background-repeat: no-repeat;
        background-position: 50% 0;
        -ms-background-size: cover;
        -o-background-size: cover;
        -moz-background-size: cover;
        -webkit-background-size: cover;
        background-size: cover;
    }
    

    
</style>







</html>
